{% extends "auth_app/base.html" %}
{% load static %}

{% block page_title %}Yangi Ariza Topshirish{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto animate-fade-in" x-data="{ applicationType: '{{ form.application_type.value|default:'DIFFERENTIATED' }}' }">
    <!-- Orqaga qaytish va Sarlavha -->
    <div>
        <a href="{% url 'grant_application_list' %}" class="inline-flex items-center text-sm font-semibold text-slate-600 hover:text-slate-800 mb-4">
            <ion-icon name="arrow-back-outline" class="mr-2"></ion-icon>
            Mening arizalarimga qaytish
        </a>
        <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">Yangi Grant Arizasi</h1>
        <p class="mt-1 text-sm text-slate-500">Iltimos, ma'lumotlarni to'ldiring va tasdiqlovchi hujjatlarni yuklang. Joriy o'quv yili: <span class="font-semibold text-primary-600">{{ active_year.year }}</span></p>
    </div>

    <form method="post" enctype="multipart/form-data" class="mt-8 space-y-8">
        {% csrf_token %}
        
        <!-- 1. Ariza turi -->
        <div class="bg-white p-6 rounded-xl shadow-soft border border-slate-100">
            <h3 class="text-lg font-semibold text-slate-800 border-b border-slate-200 pb-3 mb-4">1. Ariza turini tanlang</h3>
            <div>
                <label for="{{ form.application_type.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-1">{{ form.application_type.label }}</label>
                <!-- Alpine.js bilan o'zgaruvchini bog'lash -->
                <select name="{{ form.application_type.name }}" id="{{ form.application_type.id_for_label }}" x-model="applicationType" class="form-input">
                    {% for value, text in form.application_type.field.choices %}
                        <option value="{{ value }}" {% if form.application_type.value == value %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                </select>
                {% if form.application_type.errors %}<p class="text-red-500 text-xs mt-1">{{ form.application_type.errors.0 }}</p>{% endif %}
            </div>
        </div>

        <!-- 2. Hujjatlarni yuklash (Dinamik qism) -->
        <div class="bg-white p-6 rounded-xl shadow-soft border border-slate-100">
            <div class="border-b border-slate-200 pb-3 mb-4">
                <h3 class="text-lg font-semibold text-slate-800">2. Tasdiqlovchi hujjatlarni yuklang</h3>
                <p class="text-sm text-slate-500 mt-1" x-show="applicationType === 'DIFFERENTIATED'">
                    Ijtimoiy faollikni baholash uchun quyidagi 11 ta mezon bo'yicha yutuqlaringizni tasdiqlovchi hujjatlarni yuklang.
                </p>
                 <p class="text-sm text-slate-500 mt-1" x-show="applicationType !== 'DIFFERENTIATED'">
                    Arizangizni asoslash uchun kerakli hujjatlarni (masalan, maxsus toifani tasdiqlovchi ma'lumotnoma) yuklang.
                </p>
            </div>
            
            <!-- 11 mezon uchun yo'riqnoma (faqat tabaqalashtirilgan grant uchun ko'rinadi) -->
            <div class="mb-6 p-4 bg-primary-50 border border-primary-100 rounded-lg text-sm text-primary-800" x-show="applicationType === 'DIFFERENTIATED'" x-transition>
                <p class="font-semibold mb-2">Eslatma: Hujjatlaringiz quyidagi mezonlardan biriga tegishli bo'lishi kerak:</p>
                <ol class="list-decimal list-inside space-y-1">
                    <li>Kitobxonlik madaniyati (0-20 ball)</li>
                    <li>“5 muhim tashabbus” ishtiroki (0-20 ball)</li>
                    <li>Akademik o‘zlashtirish (qo'shimcha) (0-10 ball)</li>
                    <li>Odob-axloq qoidalari (0-5 ball)</li>
                    <li>Musobaqa va tanlovlar (0-10 ball)</li>
                    <li>Davomat (0-5 ball)</li>
                    <li>“Ma’rifat darslari” (0-10 ball)</li>
                    <li>Volontyorlik (0-5 ball)</li>
                    <li>Madaniy tadbirlar (0-5 ball)</li>
                    <li>Sport va sog‘lom turmush tarzi (0-5 ball)</li>
                    <li>Boshqa ma’naviy faoliyat (0-5 ball)</li>
                </ol>
            </div>
            
            <!-- Formset -->
            {{ formset.management_form }}
            <div id="document-formset" class="space-y-6">
                {% for doc_form in formset %}
                <div class="document-form p-4 border border-slate-200 rounded-lg relative transition-all" 
                     id="document-{{ forloop.counter0 }}">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- YANGI MEZON TANLASH MAYDONI -->
                        <div class="sm:col-span-2">
                            <label for="{{ doc_form.evaluation_criterion.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-1">{{ doc_form.evaluation_criterion.label }}</label>
                            {{ doc_form.evaluation_criterion }}
                            {% if doc_form.evaluation_criterion.errors %}<p class="text-red-500 text-xs mt-1">{{ doc_form.evaluation_criterion.errors.0 }}</p>{% endif %}
                        </div>

                        <div>
                            <label for="{{ doc_form.description.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-1">{{ doc_form.description.label }}</label>
                            {{ doc_form.description }}
                            {% if doc_form.description.errors %}<p class="text-red-500 text-xs mt-1">{{ doc_form.description.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                             <label for="{{ doc_form.file.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-1">{{ doc_form.file.label }}</label>
                             {{ doc_form.file }}
                             {% if doc_form.file.errors %}<p class="text-red-500 text-xs mt-1">{{ doc_form.file.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                     {% if formset.can_delete %}
                        <div class="absolute top-2 right-2">
                            <button type="button" onclick="removeForm(this)" class="remove-form-btn text-slate-400 hover:text-red-500 transition-colors" title="Ushbu hujjatni o'chirish">
                                <ion-icon name="trash-outline" class="text-lg"></ion-icon>
                            </button>
                             {{ doc_form.DELETE }}
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <!-- Yangi bo'sh forma uchun shablon (JavaScript uchun) -->
            <template id="empty-form-template">
                <div class="document-form p-4 border border-slate-200 rounded-lg relative transition-all">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="sm:col-span-2">
                            <label for="id_documents-__prefix__-evaluation_criterion" class="block text-sm font-medium text-slate-700 mb-1">Hujjat qaysi mezonga oid?</label>
                            {{ formset.empty_form.evaluation_criterion }}
                        </div>
                        <div>
                            <label for="id_documents-__prefix__-description" class="block text-sm font-medium text-slate-700 mb-1">Hujjat tavsifi</label>
                            {{ formset.empty_form.description }}
                        </div>
                        <div>
                             <label for="id_documents-__prefix__-file" class="block text-sm font-medium text-slate-700 mb-1">Faylni tanlang</label>
                             {{ formset.empty_form.file }}
                        </div>
                    </div>
                    <div class="absolute top-2 right-2">
                        <button type="button" onclick="removeForm(this)" class="remove-form-btn text-slate-400 hover:text-red-500 transition-colors" title="Ushbu hujjatni o'chirish">
                            <ion-icon name="trash-outline" class="text-lg"></ion-icon>
                        </button>
                        {{ formset.empty_form.DELETE }}
                    </div>
                </div>
            </template>

            <button type="button" id="add-form-btn" class="mt-6 inline-flex items-center text-sm font-medium text-primary-600 hover:text-primary-800">
                <ion-icon name="add-outline" class="mr-1"></ion-icon>
                Yana hujjat qo'shish
            </button>
        </div>

        <!-- Yakunlash tugmasi -->
        <div class="pt-5 flex justify-end">
            <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center px-8 py-3 bg-primary-600 text-white text-base font-semibold rounded-lg shadow-sm hover:bg-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                Arizani Yuborish
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const addFormBtn = document.querySelector('#add-form-btn');
    const formsetContainer = document.querySelector('#document-formset');
    const totalFormsInput = document.querySelector('input[name="documents-TOTAL_FORMS"]');
    const emptyFormTemplate = document.querySelector('#empty-form-template');

    addFormBtn.addEventListener('click', () => {
        const formIndex = parseInt(totalFormsInput.value);
        const newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formIndex);
        
        const newDiv = document.createElement('div');
        newDiv.innerHTML = newFormHtml;
        const newFormElement = newDiv.firstElementChild;
        newFormElement.id = `document-${formIndex}`;
        
        // Yangi formani tozalash (agar kerak bo'lsa)
        newFormElement.querySelectorAll('input, select, textarea').forEach(input => {
            if(input.type !== 'checkbox') {
                input.value = '';
            }
        });
        
        formsetContainer.appendChild(newFormElement);
        totalFormsInput.value = formIndex + 1;
    });

    function removeForm(button) {
        const formWrapper = button.closest('.document-form');
        const deleteCheckbox = formWrapper.querySelector('input[type="checkbox"]');
        if (deleteCheckbox) {
            deleteCheckbox.checked = true;
            formWrapper.style.display = 'none';
        } else {
            formWrapper.remove();
        }
    }
</script>
{% endblock %}